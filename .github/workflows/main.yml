name: Flask-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        pip install -r requirements.txt

    - name: Lint with flake8
      run: flake8 .

    - name: Test with pytest
      run: pytest tests.py
      
  
  push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Push to Docker Hub
        uses: docker/build-push-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: sergeidocker/flask-app
          tag_with_ref: true
          
  deploy:
    runs-on: ubuntu-latest
    needs: push_to_docker_hub
    steps:
      - name: executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: $ MIIEowIBAAKCAQEArG0z7tmUleAhoyZGqFW7IImLZZ1C/oiyB7YeBdJ/3KIu2QuhLeQxgf8ucRXIpBsnT6XPh6Sv9CDJ9a6WcVfN5ADK/8jMZEMqQcxStJftum4Kpg5SubYVtn3Gd28sFNb96OdqrSbJHBv1eBXF+gQXOSqZskPKnK5RrytwBzz5LiWIKjCFH94o1M0tfr2fjJ+Cz/5QzgN1NxUMl0SK4Y/5h5r8+UFVMySC8MBZlpJErSR3AkWOdj1V92Dx3lcPxkaSVG2feBvligjjnJIxi+nytrwnLTSwpp/UsWff9LyFr8BHpbXwmxWoXUl6B+bRb4bOXoGn6xzFq3dtJJGhH59zlQIDAQABAoIBAB9ZH0b+gdgZzqPF0rTKGWJZ/2DzDXoPSibCwoSWd66aQeAuEBiy0xlqVnwy1K6ZTTVa1Pc5RtAgofcrzag/qWwZhM6qKBbWazlZN3Qj5xGs7fywv/OJmjr6dPnD2YTUbYdJg4iFc6zLnH4/nyXMVpiLGTRixNRlkO5C/HQkbr0nw0WpZbbhdddkmzsq06JtPnwqxT9XHvw+FwUUyGENcdTPEaJDNJePeJeeN35DPlWkI4Wh+EXChpFkby5hXU3Vo/nOzty7YR5t9kUffw1bYDZcD9xZOe2XlDSgn0/+8yz3p3KqWUbzd/ZL1OZSNMYmStVbtCKYw1LlQu1LjWkgv2ECgYEA11QRrdkCkrl9ejyD530v78u4zHNY8V27FkaiHSo9DplpBAjlnYg9Qv87StCk+8zORDuI3q4La/KZLhx3Uc1U644d7hxT1E/EY9ZzOPr6aFTGifByxgwvwVJJCBJrw3RhUvAdyoxfI+HVQMaq+wyoWD2eyMMNF2gexNJuRUPDs/0CgYEAzP6rtqJh4Hiig3VRGXhfrUjejKqrlRKWVLJ72ig2bi4YZSeD2wQsn41WPQVsGdNT6tkCu0LWs3f8U9Jc92uihjxmfvwfbj4XG05HniiBwkAtpMqaYIqMkd+3DEuhwWVQdzofFDfR+lXb2BgQsUXns1klL9mDKsdtPpQhn/QMNXkCgYEAhblT8V8f1fcUEeGbGRwJtSYTcgUAa4UGNuNOskYU/QgQy8yqrJZ7VSwkqmXA0A902bMPYRs9RKC4uIY9I7Qc1NzBgapd9TBEiqwXin9zG2/qjKei35OZ5LkxWa329r9D4bn1BmD+hM4vHbdDX/2QXpyGC6/2ZV7oHNuCV8mptBECgYAHBntQCQSdssSvCKg83Tk6MRMfcwHqW/a29F72PQaQhBfl75K/QMdeuHNKKBNqVym7FLDZRhMhl20YWk9BU3kAbLV+iJlzJ8GW9/nQW8cGpzhpO2BLCrSCk04sp7Llc9lsHJvQD5GsqKCeKUT5LlIgfV+e4i9ymd8Ok/kLCEwa0QKBgG6NzdohzunE7hF81IRUtW8G2LIoiJN1FTf/peqbn/Ky4JtKFFxIKKSKtaMFlyF7kwzMDaqZcJjgd4rrUDMAHyFAJYYrEydGIsZtvKCB2mstuqaqGJ96nlcj2r/pOxhyh8X0jzzE3FExgojjamXNUSs0bzKF/0okj3iWvk2lB1iI
          #passphrase: ${{ secrets.PASSPHRASE }} # если ваш ssh-ключ защищен фразой-паролем
          script: |
            sudo docker pull sergeidocker/flask-app
            sudo docker stop $(docker ps -a -q)
            sudo docker run --rm -d -p 5000:5000 sergeidocker/flask-app
 
